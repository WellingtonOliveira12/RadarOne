generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String         @id @default(cuid())
  email            String         @unique
  password         String
  name             String
  phone            String?
  telegram_chat_id String?
  role             UserRole       @default(USER)
  isActive         Boolean        @default(true) @map("is_active")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  monitors         Monitor[]
  subscriptions    Subscription[]
  usageLogs        UsageLog[]

  @@map("users")
}

model Plan {
  id              String         @id @default(cuid())
  name            String         @unique
  slug            String         @unique
  description     String?
  price           Float
  monthly_queries Int
  maxMonitors     Int?           @map("max_monitors")
  multi_site      Boolean        @default(false)
  checkInterval   Int            @default(60) @map("check_interval")
  isActive        Boolean        @default(true) @map("is_active")
  isLifetime      Boolean        @default(false) @map("is_lifetime")
  kiwifyProductId String?        @map("kiwify_product_id")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  coupons         Coupon[]
  subscriptions   Subscription[]

  @@map("plans")
}

model Subscription {
  id               String             @id @default(cuid())
  userId           String             @map("user_id")
  planId           String             @map("plan_id")
  status           SubscriptionStatus @default(ACTIVE)
  startDate        DateTime           @default(now()) @map("start_date")
  end_date         DateTime?
  queriesUsed      Int                @default(0) @map("queries_used")
  queriesLimit     Int                @map("queries_limit")
  isLifetime       Boolean            @default(false) @map("is_lifetime")
  isTrial          Boolean            @default(false) @map("is_trial")
  trialEndsAt      DateTime?          @map("trial_ends_at")
  kiwifyOrderId    String?            @unique @map("kiwify_order_id")
  kiwifyCustomerId String?            @map("kiwify_customer_id")
  createdAt        DateTime           @default(now()) @map("created_at")
  updatedAt        DateTime           @updatedAt @map("updated_at")
  plan             Plan               @relation(fields: [planId], references: [id])
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

model Coupon {
  id           String        @id @default(cuid())
  code         String        @unique
  type         CouponType
  discount     Float?
  plan_id      String?
  maxUses      Int?          @map("max_uses")
  current_uses Int           @default(0)
  expiresAt    DateTime?     @map("expires_at")
  isActive     Boolean       @default(true) @map("is_active")
  description  String?
  createdAt    DateTime      @default(now()) @map("created_at")
  updatedAt    DateTime      @updatedAt @map("updated_at")
  usageLogs    CouponUsage[]
  plans        Plan?         @relation(fields: [plan_id], references: [id])

  @@map("coupons")
}

model CouponUsage {
  id       String   @id @default(cuid())
  couponId String   @map("coupon_id")
  userId   String   @map("user_id")
  usedAt   DateTime @default(now()) @map("used_at")
  coupon   Coupon   @relation(fields: [couponId], references: [id])

  @@index([couponId])
  @@index([userId])
  @@map("coupon_usage")
}

model Monitor {
  id              String       @id @default(cuid())
  userId          String       @map("user_id")
  name            String
  site            MonitorSite
  searchUrl       String       @map("search_url")
  priceMin        Float?       @map("price_min")
  priceMax        Float?       @map("price_max")
  active          Boolean      @default(true)
  filters         Json?
  keywords        String[]     @default([])
  excludeKeywords String[]     @default([]) @map("exclude_keywords")
  checkInterval   Int          @default(60) @map("check_interval")
  lastCheckedAt   DateTime?    @map("last_checked_at")
  lastAlertAt     DateTime?    @map("last_alert_at")
  alertsEnabled   Boolean      @default(true) @map("alerts_enabled")
  createdAt       DateTime     @default(now()) @map("created_at")
  updatedAt       DateTime     @updatedAt @map("updated_at")
  adsSeen         AdSeen[]
  logs            MonitorLog[]
  user            User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([active])
  @@map("monitors")
}

model AdSeen {
  id          String    @id @default(cuid())
  monitorId   String    @map("monitor_id")
  externalId  String    @map("external_id")
  title       String
  description String?
  price       Float?
  url         String
  imageUrl    String?   @map("image_url")
  location    String?
  publishedAt DateTime? @map("published_at")
  firstSeenAt DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime  @default(now()) @map("last_seen_at")
  alertSent   Boolean   @default(false) @map("alert_sent")
  alertSentAt DateTime? @map("alert_sent_at")
  metadata    Json?
  monitor     Monitor   @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@unique([monitorId, externalId])
  @@index([monitorId])
  @@map("ads_seen")
}

model MonitorLog {
  id            String    @id @default(cuid())
  monitorId     String    @map("monitor_id")
  status        LogStatus
  adsFound      Int       @default(0) @map("ads_found")
  newAds        Int       @default(0) @map("new_ads")
  alertsSent    Int       @default(0) @map("alerts_sent")
  error         String?
  executionTime Int?      @map("execution_time")
  createdAt     DateTime  @default(now()) @map("created_at")
  monitor       Monitor   @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId])
  @@index([createdAt])
  @@map("monitor_logs")
}

model UsageLog {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  action      String
  details     Json?
  queriesUsed Int      @default(1) @map("queries_used")
  createdAt   DateTime @default(now()) @map("created_at")
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("usage_logs")
}

model WebhookLog {
  id        String   @id @default(cuid())
  event     String
  payload   Json
  processed Boolean  @default(false)
  error     String?
  createdAt DateTime @default(now()) @map("created_at")

  @@index([event])
  @@index([processed])
  @@map("webhook_logs")
}

enum UserRole {
  USER
  ADMIN
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
  TRIAL
}

enum MonitorSite {
  MERCADO_LIVRE
  OLX
  FACEBOOK_MARKETPLACE
  WEBMOTORS
  ICARROS
  ZAP_IMOVEIS
  VIVA_REAL
  IMOVELWEB
  OUTRO
}

enum LogStatus {
  SUCCESS
  ERROR
  PARTIAL
}

enum CouponType {
  PERCENTAGE
  FIXED_AMOUNT
  FREE_TRIAL
  LIFETIME
}
