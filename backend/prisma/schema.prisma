// Schema do RadarOne - Sistema de Monitoramento de Anúncios

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// USUÁRIOS E AUTENTICAÇÃO
// ============================================

model User {
  id            String         @id @default(uuid())
  email         String         @unique
  password      String
  name          String
  phone         String?
  telegramChatId String?      @map("telegram_chat_id")
  role          UserRole       @default(USER)
  isActive      Boolean        @default(true) @map("is_active")
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")

  // Relações
  subscriptions Subscription[]
  monitors      Monitor[]
  usageLogs     UsageLog[]

  @@map("users")
}

enum UserRole {
  USER
  ADMIN
}

// ============================================
// PLANOS E ASSINATURAS
// ============================================

model Plan {
  id                String         @id @default(uuid())
  name              String         @unique // Starter, Standard, Pro, Master, Ultra, Vitalicio
  slug              String         @unique // starter, standard, pro, master, ultra, lifetime
  description       String?
  price             Float          // Preço em reais
  monthlyQueries    Int            @map("monthly_queries") // Quantidade de consultas por mês
  maxMonitors       Int?           @map("max_monitors") // Quantidade máxima de monitores ativos (null = ilimitado)
  multiSite         Boolean        @default(false) @map("multi_site") // Se permite monitores em múltiplos sites
  checkInterval     Int            @default(60) @map("check_interval") // Intervalo de verificação em minutos
  isActive          Boolean        @default(true) @map("is_active")
  isLifetime        Boolean        @default(false) @map("is_lifetime") // Plano vitalício
  kiwifyProductId   String?        @map("kiwify_product_id") // ID do produto na Kiwify
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  // Relações
  subscriptions     Subscription[]
  coupons           Coupon[]

  @@map("plans")
}

model Subscription {
  id                String             @id @default(uuid())
  userId            String             @map("user_id")
  planId            String             @map("plan_id")
  status            SubscriptionStatus @default(ACTIVE)
  startDate         DateTime           @default(now()) @map("start_date")
  endDate           DateTime?          @map("end_date")
  queriesUsed       Int                @default(0) @map("queries_used") // Consultas usadas no período
  queriesLimit      Int                @map("queries_limit") // Limite de consultas
  isLifetime        Boolean            @default(false) @map("is_lifetime")
  isTrial           Boolean            @default(false) @map("is_trial")
  trialEndsAt       DateTime?          @map("trial_ends_at")

  // Integração Kiwify
  kiwifyOrderId     String?            @unique @map("kiwify_order_id")
  kiwifyCustomerId  String?            @map("kiwify_customer_id")

  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  // Relações
  user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan              Plan               @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([status])
  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
  TRIAL
}

// ============================================
// CUPONS
// ============================================

model Coupon {
  id              String        @id @default(uuid())
  code            String        @unique
  type            CouponType
  discount        Float?        // Desconto em % ou valor fixo
  planId          String?       @map("plan_id") // Se for cupom de plano específico (ex: vitalício)
  maxUses         Int?          @map("max_uses") // Máximo de usos (null = ilimitado)
  currentUses     Int           @default(0) @map("current_uses")
  expiresAt       DateTime?     @map("expires_at")
  isActive        Boolean       @default(true) @map("is_active")
  description     String?
  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relações
  plan            Plan?         @relation(fields: [planId], references: [id])
  usageLogs       CouponUsage[]

  @@map("coupons")
}

enum CouponType {
  PERCENTAGE     // Desconto percentual
  FIXED_AMOUNT   // Desconto fixo
  FREE_TRIAL     // Teste grátis
  LIFETIME       // Acesso vitalício
}

model CouponUsage {
  id        String   @id @default(uuid())
  couponId  String   @map("coupon_id")
  userId    String   @map("user_id")
  usedAt    DateTime @default(now()) @map("used_at")

  // Relações
  coupon    Coupon   @relation(fields: [couponId], references: [id])

  @@index([couponId])
  @@index([userId])
  @@map("coupon_usage")
}

// ============================================
// MONITORES
// ============================================

// Enum de sites de monitores (CRUD API)
// Scrapers implementados: MERCADO_LIVRE (placeholder), OLX (placeholder)
// Scrapers pendentes: LEILAO, WEBMOTORS, ICARROS, ZAP_IMOVEIS, VIVA_REAL, IMOVELWEB
enum MonitorSite {
  MERCADO_LIVRE
  OLX
  LEILAO
  WEBMOTORS       // Portal de veículos
  ICARROS         // Portal de veículos
  ZAP_IMOVEIS     // Portal de imóveis
  VIVA_REAL       // Portal de imóveis
  IMOVELWEB       // Portal de imóveis
}

model Monitor {
  id              String        @id @default(cuid())
  userId          String        @map("user_id")
  name            String        // Nome do monitor (ex: "Apartamentos SP Centro")
  site            MonitorSite   // Site a monitorar (enum simplificado)
  searchUrl       String        @map("search_url") // URL de busca configurada
  priceMin        Float?        @map("price_min") // Preço mínimo
  priceMax        Float?        @map("price_max") // Preço máximo
  active          Boolean       @default(true)    // Se o monitor está ativo

  // Campos adicionais (mantidos para compatibilidade com worker)
  filters         Json?         // Filtros específicos (JSON)
  keywords        String[]      @default([]) // Palavras-chave para buscar
  excludeKeywords String[]      @default([]) @map("exclude_keywords") // Palavras para excluir
  checkInterval   Int           @default(60) @map("check_interval") // Minutos entre verificações
  lastCheckedAt   DateTime?     @map("last_checked_at")
  lastAlertAt     DateTime?     @map("last_alert_at")
  alertsEnabled   Boolean       @default(true) @map("alerts_enabled")

  createdAt       DateTime      @default(now()) @map("created_at")
  updatedAt       DateTime      @updatedAt @map("updated_at")

  // Relações
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  adsSeen         AdSeen[]
  logs            MonitorLog[]

  @@index([userId])
  @@index([active])
  @@map("monitors")
}

// ============================================
// ANÚNCIOS VISTOS
// ============================================

model AdSeen {
  id          String    @id @default(uuid())
  monitorId   String    @map("monitor_id")
  externalId  String    @map("external_id") // ID do anúncio no site externo
  title       String
  description String?
  price       Float?
  url         String
  imageUrl    String?   @map("image_url")
  location    String?
  publishedAt DateTime? @map("published_at")
  firstSeenAt DateTime  @default(now()) @map("first_seen_at")
  lastSeenAt  DateTime  @default(now()) @map("last_seen_at")
  alertSent   Boolean   @default(false) @map("alert_sent") // Se já foi enviado alerta
  alertSentAt DateTime? @map("alert_sent_at")
  metadata    Json?     // Outros dados específicos do site

  // Relações
  monitor     Monitor   @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@unique([monitorId, externalId])
  @@index([monitorId])
  @@map("ads_seen")
}

// ============================================
// LOGS DE EXECUÇÃO
// ============================================

model MonitorLog {
  id            String      @id @default(uuid())
  monitorId     String      @map("monitor_id")
  status        LogStatus
  adsFound      Int         @default(0) @map("ads_found") // Anúncios encontrados
  newAds        Int         @default(0) @map("new_ads") // Anúncios novos
  alertsSent    Int         @default(0) @map("alerts_sent") // Alertas enviados
  error         String?     // Mensagem de erro, se houver
  executionTime Int?        @map("execution_time") // Tempo de execução em ms
  createdAt     DateTime    @default(now()) @map("created_at")

  // Relações
  monitor       Monitor     @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId])
  @@index([createdAt])
  @@map("monitor_logs")
}

enum LogStatus {
  SUCCESS
  ERROR
  PARTIAL // Sucesso parcial
}

// ============================================
// HISTÓRICO DE USO
// ============================================

model UsageLog {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  action      String    // Tipo de ação: "monitor_check", "alert_sent", etc
  details     Json?     // Detalhes adicionais
  queriesUsed Int       @default(1) @map("queries_used") // Consultas consumidas
  createdAt   DateTime  @default(now()) @map("created_at")

  // Relações
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@map("usage_logs")
}

// ============================================
// WEBHOOKS KIWIFY
// ============================================

model WebhookLog {
  id          String    @id @default(uuid())
  event       String    // Tipo de evento Kiwify
  payload     Json      // Payload completo do webhook
  processed   Boolean   @default(false)
  error       String?
  createdAt   DateTime  @default(now()) @map("created_at")

  @@index([event])
  @@index([processed])
  @@map("webhook_logs")
}
